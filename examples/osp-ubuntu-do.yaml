# Copyright 2021 The Operating System Manager contributors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: operatingsystemmanager.k8c.io/v1alpha1
kind: OperatingSystemProfile
metadata:
  name: osp-ubuntu-do
  namespace: kube-system
spec:
  osName: "ubuntu"
  osVersion: "20.04"
  supportedCloudProviders:
    - name: "do"
      spec:
        region: "fra1"
  units:
    - name: test-unit-1
      enable: true
      content: "test unit content"
  files:
   
    - path: "/etc/systemd/journald.conf.d/max_disk_use.conf"
      content:
        inline:
          encoding: b64
          data: |
            [Journal]
            SystemMaxUse=5G

    - path: "/opt/load-kernel-modules.sh"
      permissions: 0755
      content:
        inline:
          encoding: b64
          data: |
            #!/usr/bin/env bash
            set -euo pipefail

            modprobe ip_vs
            modprobe ip_vs_rr
            modprobe ip_vs_wrr
            modprobe ip_vs_sh

            if modinfo nf_conntrack_ipv4 &> /dev/null; then
              modprobe nf_conntrack_ipv4
            else
              modprobe nf_conntrack
            fi
 
    - path: "/etc/sysctl.d/k8s.conf"
      content:
        inline:
          encoding: b64
          data: |
            net.bridge.bridge-nf-call-ip6tables = 1
            net.bridge.bridge-nf-call-iptables = 1
            kernel.panic_on_oops = 1
            kernel.panic = 10
            net.ipv4.ip_forward = 1
            vm.overcommit_memory = 1
            fs.inotify.max_user_watches = 1048576

    - path: "/etc/default/grub.d/60-swap-accounting.cfg"
      content:
        inline:
          encoding: b64
          data: |
            # Added by kubermatic machine-controller
            # Enable cgroups memory and swap accounting
            GRUB_CMDLINE_LINUX="cgroup_enable=memory swapaccount=1"
            
    - path: "/opt/bin/setup"
      permissions: 0755
      content:
        inline:
          encoding: b64
          data: |
            #!/bin/bash
            set -xeuo pipefail
            if systemctl is-active ufw; then systemctl stop ufw; fi
            systemctl mask ufw

            {{- /* As we added some modules and don't want to reboot, restart the service */}}
            systemctl restart systemd-modules-load.service
            sysctl --system

            {{- /* Make sure we always disable swap - Otherwise the kubelet won't start'. */}}
            sed -i.orig '/.*swap.*/d' /etc/fstab
            swapoff -a

            apt-get update

            DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y \
              curl \
              ca-certificates \
              ceph-common \
              cifs-utils \
              conntrack \
              e2fsprogs \
              ebtables \
              ethtool \
              glusterfs-client \
              iptables \
              jq \
              kmod \
              openssh-client \
              nfs-common \
              socat \
              util-linux \
              {{- if eq .CloudProviderName "vsphere" }}
              open-vm-tools \
              {{- end }}
              ipvsadm

            # Update grub to include kernel command options to enable swap accounting.
            # Exclude alibaba cloud until this is fixed https://github.com/kubermatic/machine-controller/issues/682
            {{ if eq .CloudProviderName "alibaba" }}
            if grep -v -q swapaccount=1 /proc/cmdline
            then
              echo "Reboot system if not alibaba cloud"
              update-grub
              touch /var/run/reboot-required
            fi
            {{ end }}
            
            apt-get update
            apt-get install -y apt-transport-https ca-certificates curl software-properties-common lsb-release
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
            add-apt-repository "deb https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

            mkdir -p /etc/systemd/system/containerd.service.d /etc/systemd/system/docker.service.d

            cat <<EOF | tee /etc/systemd/system/containerd.service.d/environment.conf /etc/systemd/system/docker.service.d/environment.conf
            [Service]
            Restart=always
            EnvironmentFile=-/etc/environment
            EOF

            apt-get install -y \
                containerd.io=1.4.3* \
                docker-ce=5:19.03.13* \
                docker-ce-cli=5:19.03.13*
            apt-mark hold docker-ce docker-ce-cli containerd.io

            systemctl daemon-reload
            systemctl enable --now docker


            {{ .SafeDownloadBinariesScript }}
            # set kubelet nodeip environment variable
            /opt/bin/setup_net_env.sh

            systemctl enable --now kubelet
            systemctl enable --now --no-block kubelet-healthcheck.service

    - path: "/opt/bin/supervise.sh"
      permissions: 0755
      content:
        inline:
          encoding: b64
          data: |
            #!/bin/bash
            set -xeuo pipefail
            while ! "$@"; do
              sleep 1
            done

    - path: "/etc/systemd/system/kubelet.service"
      content:
        inline:
          encoding: b64
          data: |
            {{ .KubeletSystemdUnit }}

    - path: "/etc/systemd/system/kubelet.service.d/extras.conf"
      content:
        inline:
          encoding: b64
          data: |
            [Service]
            Environment="KUBELET_EXTRA_ARGS=--resolv-conf=/run/systemd/resolve/resolv.conf"

    - path: "/etc/kubernetes/cloud-config"
      permissions: 0600
      content:
        inline:
          encoding: b64
          data: |


    - path: "/opt/bin/setup_net_env.sh"
      permissions: 0755
      content:
        inline:
          encoding: b64
          data: |
            #!/usr/bin/env bash
            echodate() {
              echo "[$(date -Is)]" "$@"
            }

            # get the default interface IP address
            DEFAULT_IFC_IP=$(ip -o  route get 1 | grep -oP "src \K\S+")

            if [ -z "${DEFAULT_IFC_IP}" ]
            then
              echodate "Failed to get IP address for the default route interface"
              exit 1
            fi

            # write the nodeip_env file
            # we need the line below because flatcar has the same string "coreos" in that file
            if grep -q coreos /etc/os-release
            then
              echo "KUBELET_NODE_IP=${DEFAULT_IFC_IP}" > /etc/kubernetes/nodeip.conf
            elif [ ! -d /etc/systemd/system/kubelet.service.d ]
            then
              echodate "Can't find kubelet service extras directory"
              exit 1
            else
              echo -e "[Service]\nEnvironment=\"KUBELET_NODE_IP=${DEFAULT_IFC_IP}\"" > /etc/systemd/system/kubelet.service.d/nodeip.conf
            fi


    - path: "/etc/kubernetes/bootstrap-kubelet.conf"
      permissions: 0600
      content:
        inline:
          encoding: b64
          data: |
            {{ .Kubeconfig }}


    - path: "/etc/kubernetes/pki/ca.crt"
      content:
        inline:
          encoding: b64
          data: |
            {{ .KubernetesCACert }}


    - path: "/etc/systemd/system/setup.service"
      permissions: 0644
      content:
        inline:
          encoding: b64
          data: |
            [Install]
            WantedBy=multi-user.target

            [Unit]
            Requires=network-online.target
            After=network-online.target

            [Service]
            Type=oneshot
            RemainAfterExit=true
            EnvironmentFile=-/etc/environment
            ExecStart=/opt/bin/supervise.sh /opt/bin/setup

    - path: "/etc/profile.d/opt-bin-path.sh"
      permissions: 0644
      content:
        inline:
          encoding: b64
          data: |
            export PATH="/opt/bin:$PATH"

    - path: /etc/docker/daemon.json
      permissions: 0644
      content:
        inline:
          encoding: b64
          data: |
            {"exec-opts":["native.cgroupdriver=systemd"],"storage-driver":"overlay2","log-driver":"json-file","log-opts":{"max-size":"100m"}}

    - path: "/etc/kubernetes/kubelet.conf"
      content:
        inline:
          encoding: b64
          data: |
            {{ .KubeletConfiguration }}


    - path: /etc/systemd/system/kubelet-healthcheck.service
      permissions: 0644
      content:
        inline:
          encoding: b64
          data: |
            [Unit]
            Requires=kubelet.service
            After=kubelet.service

            [Service]
            ExecStart=/opt/bin/health-monitor.sh kubelet

            [Install]
            WantedBy=multi-user.target

                
                  
